---
title: "Menu Cost"
author: "Cheng,Tien"
date: "2023-08-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("R/support.R")
library(targets)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(plotly)
library(tidyr)
library(readxl)
tar_load(AverageInflationRatePercentage)
tar_load(c(popularItems,average_menu_cost_wax_before,average_menu_cost_wax_after,
           average_menu_cost_wane_before,average_menu_cost_wane_after))
tar_load(c(filtered_average_inflation_rate_wax,filtered_average_inflation_rate_wane))
tar_load(c(menu_wax,menu_wane))
tar_load(c(persistent_popularItems_count,table_persistent_popularItems_count))
tar_load(mealOffering_shopCodes)
tar_load(business_hour_types)
tar_load(menu_wax_offerMeal)
tar_load(tracking_shopCodes_mealOffering)
tar_load(c(cpi_wax,cpi_wane,tb_cpi_summary))
tar_load(c(summary_price_wax_before,summary_price_wax_after,summary_price_wane_after,tb_price_summary))
tar_load(c(summary_AvgPrice_wax_before,summary_AvgPrice_wax_after,
           summary_AvgPrice_wane_after,tb_AvgPrice_summary))
tar_load(c(summary_byGroup_wax_before,
         summary_byGroup_wax_after,
         summary_byGroup_wane_after,
         tb_price_byGroup_summary))
tar_load(tracking_shopCodes_mealOffering_6popularItems)
tar_load(c(menu_cost_wax_before,menu_cost_wax_after,menu_cost_wane_after,
           wax_data_before,wax_data_after,wane_data_after))
tar_load(c(average_inflation_rate_wax,average_inflation_rate_wane))
tar_load(tb_CPI_summary_byGroup)
tar_load(shopcodeCounty)
knitr::opts_chunk$set(echo = FALSE)
```

#### 計算平均物價有上漲的店家佔總店家比例

-   蛋荒較嚴重時，有較高比例的店家物價是上漲的

|period | percentage|
|:------|----------:|
|wax    |  0.2871515|
|wane   |  0.2509112|

```{r}
AverageInflationRatePercentage<-data.frame(period=c("wax","wane"),
                                           percentage=c(compute_percentage(filtered_average_inflation_rate_wax),compute_percentage(filtered_average_inflation_rate_wane)))
```

#### wax物價上漲率之四分位值

|     |           |
|:----|----------:|
|0%   | -1.5629639|
|25%  |  0.0000000|
|50%  |  0.0000000|
|75%  |  0.0170736|
|100% |  1.6669364|

```{r}
data <- data.frame(values = filtered_average_inflation_rate_wax$inflation_rate)
ggplot(data, aes(x = values)) +
  geom_histogram(binwidth = 1,breaks=seq(-1.5, 1.5, by = 0.02), fill = "skyblue", color = "black") +
  labs(title = "Histogram of Inflation Rates") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20),
  )
```


#### wane物價上漲率之四分位值
|     |           |
|:----|----------:|
|0%   | -1.8050047|
|25%  |  0.0000000|
|50%  |  0.0000000|
|75%  |  0.0016175|
|100% |  2.0152448|

```{r}
data <- data.frame(values = filtered_average_inflation_rate_wane$inflation_rate)
ggplot(data, aes(x = values)) +
  geom_histogram(binwidth = 1,breaks=seq(-1.5, 1.5, by = 0.02), fill = "skyblue", color = "black") +
  labs(title = "Histogram of Inflation Rates") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 20),
  )
```







#### 蛋荒較嚴重時期

##### 一、先觀察物價上漲率大於1的店家，總共有68間
|shopCode | inflation_rate|
|:--------|--------------:|
|lh86     |       1.666936|
|e1iw     |       1.544980|
|m8pq     |       1.513661|
|q8sf     |       1.470082|
|seuv     |       1.463255|
|d1ls     |       1.392725|
|a1ef     |       1.377926|
|b2np     |       1.377926|
|d4hj     |       1.377926|
|i3cc     |       1.377926|
|s5te     |       1.377926|
|y0yj     |       1.377926|
|ynqu     |       1.377926|
|z4nx     |       1.377926|
|z5va     |       1.377926|
|pr81     |       1.368276|
|b8db     |       1.356694|
|e3jc     |       1.356694|
|e7bo     |       1.356694|
|jedi     |       1.356694|
|q6yu     |       1.356694|
|lsd5     |       1.346513|
|z7ko     |       1.318491|
|z3bf     |       1.301379|
|y2de     |       1.297883|
|y9tu     |       1.297883|
|z4wd     |       1.297883|
|a0ba     |       1.297767|
|y7lb     |       1.272566|
|y1ys     |       1.270593|
|y9yy     |       1.270593|
|a5ji     |       1.251946|
|z0zd     |       1.237684|
|cysg     |       1.234744|
|b9xu     |       1.217724|
|awvt     |       1.178655|
|o2kj     |       1.163151|
|vl3z     |       1.152680|
|pefn     |       1.150135|
|s6bd     |       1.144223|
|z2km     |       1.144223|
|lz5w     |       1.140634|
|y7ht     |       1.139434|
|p5au     |       1.137979|
|artg     |       1.124208|
|t4bt     |       1.124208|
|z9uh     |       1.124208|
|t2jb     |       1.092371|
|zmrx     |       1.091177|
|n4xa     |       1.086190|
|mi87     |       1.078410|
|y4id     |       1.060872|
|bj3q     |       1.058538|
|tceg     |       1.041160|
|d3sc     |       1.039642|
|l0q6     |       1.039642|
|xdj5     |       1.036009|
|c2dr     |       1.019872|
|r2is     |       1.014143|
|u9kk     |       1.005522|
|t7wo     |       1.001929|
|d0gl     |       1.000428|
|d1sd     |       1.000428|
|e7yc     |       1.000428|
|e9ke     |       1.000428|
|l6pf     |       1.000428|
|z0rb     |       1.000428|
|z7je     |       1.000428|

```{r,include=FALSE}
filtered_average_inflation_rate_wax|>
  dplyr::filter(inflation_rate>1)|>
  arrange(desc(inflation_rate))
```

##### *再取出物價上漲率最高的三間做觀察*

##### **shopcode為lh86店家**
|period | averageCost|
|:------|-----------:|
|before |      39.690|
|after  |     210.195|



##### lh86店家的熱門品項

```{r}
popularItems["lh86"]
```

##### lh86店家在wane_before的菜單

```{r}
menu_wax$before["lh86"]|>jsonlite::fromJSON()->lh86_wax_before
lh86_wax_before$product
```

##### lh86店家在wane_after的菜單

```{r}
menu_wax$after["lh86"]|>jsonlite::fromJSON()->lh86_wax_after
lh86_wax_after$product
```

-   可以發現在before時只有計算到[胡麻豆腐]的價格
-   after則是抓取[御上蒲燒鰻魚餐盒、胡麻豆腐]的價格
-   但熱門品項[聖選之最舒肥牛板腱餐盒、御膳牛五花餐盒、滿肉饗宴牛五花燒肉丼、客選雙拼牛五花燒肉丼]並未出現在wane時期的菜單裡，我猜測這幾個品項是蛋荒較趨緩時才推出的商品

##### **shopcode為e1iw店家**
|period | averageCost|
|:------|-----------:|
|before |     55.0000|
|after  |    257.8333|



##### e1iw店家的熱門品項

```{r}
popularItems["e1iw"]
```

##### e1iw店家在wane_before的菜單

```{r}
menu_wax$before["e1iw"]|>jsonlite::fromJSON()->e1iw_wax_before
e1iw_wax_before$product
```

##### e1iw店家在wane_after的菜單
```{r}
menu_wax$after["e1iw"]|>jsonlite::fromJSON()-> e1iw_wax_after
e1iw_wax_after$product

```



-   可以發現到造成價格的差異來自於品項名稱定義的不同，before的套餐皆無用【】符號。
-   假設before和after的套餐內容並無實際差別，且在before的"混搭餐"跟after的"腿塊混搭餐"是同樣商品，則抓出價格比較

|product        |February| April|
|:--------------|-------:|-----:|
|2號餐          |     140|   150|
|3號餐          |     175|   189|
|4號餐          |     185|   195|
|5號全家餐      |     399|   439|
|腿塊混搭餐     |     479|   509|
|波霸脆薯條(小) |      55|    65|

```{r,include=FALSE}
data.frame(product=c("2號餐","3號餐","4號餐",
                     "5號全家餐","腿塊混搭餐","波霸脆薯條(小)"),
           before=c(140,175,185,399,479,55),
           after=c(150,189,195,439,509,65))
```

-   可以發現到熱門品項的價格皆有上漲的趨勢，上漲的幅度大概在10元至40元不等

##### **shopcode為m8pq店家**
|period | averageCost|
|:------|-----------:|
|before |        60.0|
|after  |       272.6|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["m8pq"],
                               average_menu_cost_wax_after["m8pq"]))

```

##### m8pq店家的熱門品項

```{r}
popularItems["m8pq"]
```

##### m8pq店家在wane_before的菜單

```{r}
menu_wax$before["m8pq"]|>jsonlite::fromJSON()->m8pq_wax_before
m8pq_wax_before$product
```

##### m8pq店家在wane_after的菜單

```{r}
menu_wax$after["m8pq"]|>jsonlite::fromJSON()->m8pq_wax_after
m8pq_wax_after$product
```

-   可以發現到這間店和第二間一樣都是胖老爹炸雞，熱門品項也大致相同（少了3號餐，多了雞腿的品項）。
-   比較特別的是熱門品項[波霸脆薯條(小)]並無出現在after的菜單裡，速食店居然會有沒賣薯條的時候。
-   一樣將它的價格取出並做比較及觀察

|product        |February| April|
|:--------------|-------:|-----:|
|2號餐          |     140|   150|
|4號餐          |     185|   195|
|5號全家餐      |     399|   439|
|腿塊混搭餐     |     479|   509|
|雞腿           |      65|    70|
|波霸脆薯條(小) |      55|    NA|

```{r,include=FALSE}
data.frame(product=c("2號餐","4號餐","5號全家餐",
                     "腿塊混搭餐","雞腿","波霸脆薯條(小)"),
           before=c(140,185,399,479,65,55),
           after=c(150,195,439,509,70,NA))
```

-   可以發現到胖老爹熱門套餐類的漲幅都是相同的　　
-   由於有兩間是相同的胖老爹炸雞，但處於不同分店，再取出第四間店觀察

##### **shopcode為q8sf店家**
|period | averageCost|
|:------|-----------:|
|before |     41.0000|
|after  |    178.3333|


```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["q8sf"],
                               average_menu_cost_wax_after["q8sf"]))
```

##### q8sf店家的熱門品項

```{r}
popularItems["q8sf"]
```

##### q8sf店家在wane_before的菜單

```{r}
menu_wax$before["q8sf"]|>jsonlite::fromJSON()->q8sf_wax_before
q8sf_wax_before$product
```

##### q8sf店家在wane_after的菜單

```{r}
menu_wax$after["q8sf"]|>jsonlite::fromJSON()->q8sf_wax_after
q8sf_wax_after$product
```

-   可以觀察到造成物價上漲的原因也是來自於品項定義的不同，在before的名稱裡並無詳述餐點內容，但在after的套餐裡有詳細說明，如[ A套餐：個人份雞肉5配菜、B套餐：半隻雞4配菜、C套餐：半隻雞7配菜]
-   假設套餐組合的內容物相同，取出價格比較

|product             |February| April|
|:-------------------|------:|-----:|
|個人份雞肉【綜合部位】  |     70|    80|
|海帶根X2            |     25|    25|
|A套餐：個人份雞肉5配菜 |    210|   225|
|B套餐：半隻雞4配菜  |    280|   310|
|C套餐：半隻雞7配菜  |    360|   395|
|水蓮菜              |     28|    35|

```{r,include=FALSE}
data.frame(product=c("個人份雞肉【綜合部位】","海帶根X2","A套餐：個人份雞肉5配菜",
                     "B套餐：半隻雞4配菜","C套餐：半隻雞7配菜","水蓮菜"),
           before=c(70,25,210,280,360,28),
           after=c(80,25,225,310,395,35))
```

-   套餐類皆漲15至35元不等，而水蓮菜的漲幅來到了25%，上漲的幅度驚人

##### 小結

-   會有超過100%的成本上漲率，第一個原因來自於菜單內容的改變，前期還未推出的產品在後期推出，會形成計算平均價格的差異；而第二個原因來自於品項名稱定義的差異，在這種情形前後期菜單是相同的，但在命名上的不同會造成before沒抓到熱門品項而after有抓到，形成平均價格差異甚大的狀況。但第二種情形還能用觀察的再抓出價格做比較

##### 二、觀察物價上漲率小於-1的店家，總共有4間
|     |shopCode | inflation_rate|
|:----|:--------|--------------:|
|uvrf |uvrf     |      -1.562964|
|wdl7 |wdl7     |      -1.386294|
|j0ev |j0ev     |      -1.252763|
|r8ws |r8ws     |      -1.206193|

```{r,include=FALSE}
filtered_average_inflation_rate_wax|>dplyr::filter(inflation_rate<(-1))|>
  arrange(inflation_rate)
```

##### 觀察是否跟前一章節相同，是因為品項名稱定義造成

##### **shopcode為uvrf店家**
|period | averageCost|
|:------|-----------:|
|before |    329.3333|
|after  |     69.0000|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["uvrf"],
                               average_menu_cost_wax_after["uvrf"]))
```

##### uvrf店家的熱門品項

```{r}
popularItems["uvrf"]
```

##### uvrf店家在wane_before的菜單

```{r}
menu_wax$before["uvrf"]|>jsonlite::fromJSON()->uvrf_wax_before
uvrf_wax_before$product
```

##### uvrf店家在wane_after的菜單

```{r}
menu_wax$after["uvrf"]|>jsonlite::fromJSON()->uvrf_wax_after
uvrf_wax_after$product
```

-   可以看出[黑森林蛋糕【六吋】]只出現在before的菜單裡，after只有八吋的黑森林蛋糕，而整模的蛋糕屬於菜單裡較高單價的商品(六吋黑森林蛋糕850、八吋黑森林蛋糕1063)，會使before的平均物價高出許多

##### **shopcode為wdl7店家**
|period | averageCost|
|:------|-----------:|
|before |         140|
|after  |          35|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["wdl7"],
                               average_menu_cost_wax_after["wdl7"]))
```

##### wdl7店家的熱門品項

```{r}
popularItems["wdl7"]
```

##### wdl7店家在wane_before的菜單

```{r}
menu_wax$before["wdl7"]|>jsonlite::fromJSON()->wdl7_wax_before
wdl7_wax_before$product
```

##### wdl7店家在wane_after的菜單

```{r}
menu_wax$after["wdl7"]|>jsonlite::fromJSON()->wdl7_wax_after
wdl7_wax_after$product
```

-   before和after的菜單有些許不同，而after又只抓取到[香酥雞排（單點）]的資料。想比較這個品項在前後期的價格，但發現如果以[香酥雞排]這個名稱對應，before的價格是50元而after是35元，有點好奇一般店家會一次降15元嗎？（還是內容物不同？）

|item           | price|
|:--------------|-----:|
|香酥雞排       |    50|
|香酥雞排（單點） |    35|

```{r,include=FALSE}
data.frame(item=wdl7_wax_before$product,
           price=wdl7_wax_before$discountedPrice)|>
  dplyr::filter(item=="香酥雞排") -> wd17_before
data.frame(item=wdl7_wax_after$product,
           price=wdl7_wax_after$discountedPrice)|>
  dplyr::filter(item=="香酥雞排（單點）") -> wd17_after
bind_rows(wd17_before,wd17_after)
```

##### **shopcode為j0ev店家**
|period | averageCost|
|:------|-----------:|
|before |         105|
|after  |          30|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["j0ev"],
                               average_menu_cost_wax_after["j0ev"]))
```

##### j0ev店家的熱門品項

```{r}
popularItems["j0ev"]
```

##### j0ev店家在wane_before的菜單

```{r}
menu_wax$before["j0ev"]|>jsonlite::fromJSON()->j0ev_wax_before
j0ev_wax_before$product
```

##### j0ev店家在wane_after的菜單

```{r}
menu_wax$after["j0ev"]|>jsonlite::fromJSON()->j0ev_wax_after
j0ev_wax_after$product
```

-   此間店前後的商品差距甚大，不禁好奇這是哪間店？只有飲料的部分前後期相同，主食方面菜單大改。

##### **shopcode為r8ws店家**
|period | averageCost|
|:------|-----------:|
|before |    150.3333|
|after  |     45.0000|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wax_before["r8ws"],
                               average_menu_cost_wax_after["r8ws"]))
```

##### r8ws店家的熱門品項

```{r}
popularItems["r8ws"]
```

##### r8ws店家在wane_before的菜單

```{r}
menu_wax$before["r8ws"]|>jsonlite::fromJSON()->r8ws_wax_before
r8ws_wax_before$product
```

##### r8ws店家在wane_after的菜單

```{r}
menu_wax$after["r8ws"]|>jsonlite::fromJSON()->r8ws_wax_after
r8ws_wax_after$product
```

-   after的菜單裡主食都消失了，只剩飲料部分還存在

#### 蛋荒較趨緩時期

##### 一、先觀察物價上漲率大於1的店家，總共有20間
|shopCode | inflation_rate|
|:--------|--------------:|
|k5al     |       2.015245|
|w88l     |       1.937942|
|kccq     |       1.394327|
|r8ws     |       1.360407|
|vd0e     |       1.324292|
|l37o     |       1.303895|
|wdl7     |       1.280934|
|il9w     |       1.264462|
|jg2r     |       1.243582|
|edqs     |       1.238401|
|j05a     |       1.176179|
|wp6x     |       1.167169|
|cii4     |       1.143374|
|dgj1     |       1.140915|
|cf1p     |       1.120591|
|v3nv     |       1.069150|
|jz50     |       1.059472|
|chpw     |       1.040343|
|z1xk     |       1.029619|
|pb2n     |       1.023939|

```{r,include=FALSE}
filtered_average_inflation_rate_wane|>
  dplyr::filter(inflation_rate>1)|>
  arrange(desc(inflation_rate))
```

##### *再取出物價上漲率最高的三間做觀察*

##### **shopcode為k5al店家**
|period | averageCost|
|:------|-----------:|
|before |        39.0|
|after  |       292.6|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["k5al"],
                               average_menu_cost_wane_after["k5al"]))

```

##### k5al店家的熱門品項

```{r}
popularItems["k5al"]
```

##### k5al店家在wane_before的菜單

```{r}
menu_wane$before["k5al"]|>jsonlite::fromJSON()->k5al_wane_before
k5al_wane_before$product
```

##### k5al店家在wane_after的菜單

```{r}
menu_wane$after["k5al"]|>jsonlite::fromJSON()->k5al_wane_after
k5al_wane_after$product
```

-   可以發現到在after的菜單裡除了中文以外還加入了日文及英文，造成抓取品項名稱的差異
-   取出前後期價格來比較

|product                                   | April | July |
|:-----------------------------------------|------:|-----:|
|熟成嫩肩牛排300gミスジ Blade steak        |    438|   438|
|熟成骰子牛200gサイコロ牛 Diced beef steak |    328|   328|
|熟成骰子牛300gサイコロ牛 Diced beef steak |    438|   438|
|起司漢堡排Hamburg                         |     NA|    NA|
|豬排250g/豚ステーキpork chop              |    220|   220|
|馬鈴薯沙拉                                |     39|    39|

```{r,include=FALSE}
k5al_before<- data.frame(item=k5al_wane_before$product,
                         price=k5al_wane_before$discountedPrice)
k5al_after<- data.frame(item=k5al_wane_after$product,
                         price=k5al_wane_after$discountedPrice)

data.frame(product=c("熟成嫩肩牛排300gミスジ Blade steak",
                     "熟成骰子牛200gサイコロ牛 Diced beef steak",
                     "熟成骰子牛300gサイコロ牛 Diced beef steak",
                     "起司漢堡排Hamburg",
                     "豬排250g/豚ステーキpork chop",
                     "馬鈴薯沙拉"),
           before=c(438,328,438,NA,220,39),
           after=c(438,328,438,NA,220,39))

```

-   假設before的[安格斯混切骰子牛]就是after的[熟成骰子牛]，比較前後期差異可以發現到這間店的價格其實沒有調漲

##### **shopcode為w88l店家**
|period | averageCost|
|:------|-----------:|
|before |        45.0|
|after  |       312.5|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["w88l"],
                               average_menu_cost_wane_after["w88l"]))

```

##### w88l店家的熱門品項

```{r}
popularItems["w88l"]
```

##### w88l店家在wane_before的菜單

```{r}
menu_wane$before["w88l"]|>jsonlite::fromJSON()->w88l_wane_before
w88l_wane_before$product
```

##### w88l店家在wane_after的菜單

```{r}
menu_wane$after["w88l"]|>jsonlite::fromJSON()->w88l_wane_after
w88l_wane_after$product
```

-   可以發現這間店的前後期商品內容物不盡相同，before是以大、中、小沙鍋菜販售，after則是除了沙鍋菜外有加入其他肉品做綁售，此間店家的前後期價格較難以同一標準做比較。

##### **shopcode為kccq店家**
|period | averageCost|
|:------|-----------:|
|before |        55.8|
|after  |       225.0|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["kccq"],
                               average_menu_cost_wane_after["kccq"]))

```

##### kccq店家的熱門品項

```{r}
popularItems["kccq"]
```

##### kccq店家在wane_before的菜單

```{r}
menu_wane$before["kccq"]|>jsonlite::fromJSON()->kccq_wane_before
kccq_wane_before$product
```

##### kccq店家在wane_after的菜單

```{r}
menu_wane$after["kccq"]|>jsonlite::fromJSON()->kccq_wane_after
kccq_wane_after$product
```

-   可以發現這間店也是因為命名上的差異造成物價上漲率之高，比較兩者價格

|product                         | April| July|
|:-------------------------------|------:|-----:|
|(8葷12素)小鮮肉麻辣拌(乾拌)   |     NA|   235|
|(8葷12素)小鮮肉麻辣燙(好湯) |  152.1|   235|
|(3葷12素)小仙女麻辣拌(乾拌)  |     NA|   205|
|麻辣鴨血                        |   45.0|    NA|
|涼皮                            |   72.9|    NA|
|三合一湯                        |   49.5|    NA|

```{r,include=FALSE}
kccq_before<- data.frame(item=kccq_wane_before$product,
                         price=kccq_wane_before$discountedPrice)
kccq_after<- data.frame(item=kccq_wane_after$product,
                         price=kccq_wane_after$discountedPrice)

data.frame(product=c("(8葷12素)小鮮肉麻辣拌(乾拌)",
                     "(8葷12素)小鮮肉麻辣燙(好湯)",
                     "(3葷12素)小仙女麻辣拌(乾拌)",
                     "麻辣鴨血","涼皮","三合一湯"),
           before=c(NA,152.1,NA,45,72.9,49.5),
           after=c(235,235,205,NA,NA,NA))
```

-   前後期菜單有改變，唯一在前後期都有的商品是[小鮮肉麻辣燙]，但漲了83元，讓我好奇兩個品項名稱雖然一樣但內容物是否不同？

##### 二、觀察物價上漲率小於-1的店家，總共有11間
|shopCode | inflation_rate|
|:--------|--------------:|
|u1r2     |      -1.805005|
|we7f     |      -1.582409|
|d1ls     |      -1.494508|
|cysg     |      -1.293129|
|pv5o     |      -1.273706|
|wegr     |      -1.259543|
|alib     |      -1.258040|
|b5cu     |      -1.168680|
|yrcc     |      -1.140915|
|y1nj     |      -1.089684|
|b5vu     |      -1.054621|

```{r,include=FALSE}
filtered_average_inflation_rate_wane|>dplyr::filter(inflation_rate<(-1))|>
  arrange(inflation_rate)
```

##### **shopcode為u1r2店家**
|period | averageCost|
|:------|-----------:|
|before |       182.4|
|after  |        30.0|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["u1r2"],
                               average_menu_cost_wane_after["u1r2"]))
```

##### u1r2店家的熱門品項

```{r}
popularItems["u1r2"]
```

##### u1r2店家在wane_before的菜單

```{r}
menu_wane$before["u1r2"]|>jsonlite::fromJSON()->u1r2_wane_before
u1r2_wane_before$product
```

##### u1r2店家在wane_after的菜單

```{r}
menu_wane$after["u1r2"]|>jsonlite::fromJSON()->u1r2_wane_after
u1r2_wane_after$product
```

-   after的菜單裡只剩配菜及飲料，主食皆無出現，難以比較前後期價格差異

##### **shopcode為we7f店家**
|period | averageCost|
|:------|-----------:|
|before |         146|
|after  |          30|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["we7f"],
                               average_menu_cost_wane_after["we7f"]))
```

##### we7f店家的熱門品項

```{r}
popularItems["we7f"]
```

##### we7f店家在wane_before的菜單

```{r}
menu_wane$before["we7f"]|>jsonlite::fromJSON()->we7f_wane_before
we7f_wane_before$product
```

##### we7f店家在wane_after的菜單

```{r}
menu_wane$after["we7f"]|>jsonlite::fromJSON()->we7f_wane_after
we7f_wane_after$product
```

-   前後期菜單有些許不同，但比較兩期皆有的主食[半隻鴨]，價格皆為800，並無作價格上的調整

##### **shopcode為d1ls店家**
|period | averageCost|
|:------|-----------:|
|before |         312|
|after  |          70|

```{r,include=FALSE}
data.frame(period=c("before","after"),
                 averageCost=c(average_menu_cost_wane_before["d1ls"],
                               average_menu_cost_wane_after["d1ls"]))
```

##### d1ls店家的熱門品項

```{r}
popularItems["d1ls"]
```

##### d1ls店家在wane_before的菜單

```{r}
menu_wane$before["d1ls"]|>jsonlite::fromJSON()->d1ls_wane_before
d1ls_wane_before$product
```

##### d1ls店家在wane_after的菜單

```{r}
menu_wane$after["d1ls"]|>jsonlite::fromJSON()->d1ls_wane_after
d1ls_wane_after$product
```
- 由品項名稱可以猜測此間店應該是賣甜甜圈及飲料的店家，但在after的菜單並無出現任何甜甜圈的品項，有可能是品項已售完？


#### 細分persistent_popularItems_count的型態
```{r}
table_persistent_popularItems_count
```


##### **以是否為正餐來討論**
```{r,include=FALSE}
names(persistent_popularItems_count[persistent_popularItems_count==6]) ->shopcode_count_6
names(persistent_popularItems_count[persistent_popularItems_count==5]) ->shopcode_count_5
names(persistent_popularItems_count[persistent_popularItems_count==4]) ->shopcode_count_4
names(persistent_popularItems_count[persistent_popularItems_count==3]) ->shopcode_count_3
names(persistent_popularItems_count[persistent_popularItems_count==2]) ->shopcode_count_2
names(persistent_popularItems_count[persistent_popularItems_count==1]) ->shopcode_count_1
names(persistent_popularItems_count[persistent_popularItems_count==0]) ->shopcode_count_0
```

##### 在三期中產品名稱相同的店家，販售正餐的比例


|ShopCount | Probability|
|:---------|-----------:|
|6         |   0.4671750|
|5         |   0.1688294|
|4         |   0.0922318|
|3         |   0.0607884|
|2         |   0.0426008|
|1         |   0.0222448|
|0         |   0.1461299|

```{r}
total_shops <- sum(
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_6)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_5)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_4)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_3)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_2)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_1)),
    length(intersect(tracking_shopCodes_mealOffering, shopcode_count_0))
  )
probabilities <- c(
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_6)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_5)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_4)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_3)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_2)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_1)) / total_shops,
  length(intersect(tracking_shopCodes_mealOffering, shopcode_count_0)) / total_shops
)

data <- data.frame(
  ShopCount = c("6", "5", "4", "3", "2", "1", "0"),
  Probability = probabilities
)

ggplot(data, aes(x = ShopCount, y = Probability)) +
  geom_bar(stat = "identity") +
  labs(x = "Number of Popular Items in Shop",
       y = "Probability of Shops with Meal Offering",
       ) +
  theme_minimal() +
  theme(legend.position = "none")

```



##### **以營業時段來討論**
```{r}
#breakfast時段的店家
names_with_breakfast<-shop_business_hour("breakfast")

#lunch時段的店家
names_with_lunch<-shop_business_hour("lunch")

#dinner時段的店家
names_with_dinner<-shop_business_hour("dinner")

#brunch時段的店家
names_with_brunch<-shop_business_hour("brunch")

#hightea時段的店家
names_with_hightea<-shop_business_hour("hightea")

#bartime時段的店家
names_with_bartime<-shop_business_hour("bartime")

#midnigjt時段的店家
names_with_midnight<-shop_business_hour("midnight")

periods <- c("Breakfast", "Lunch", "Dinner", "Bartime", "Brunch", "Midnight", "Hightea")
```

##### 六個品項的店家當中的營業時間分布    
```{r}
intersection_count_6<-intersection_counts(shopcode_count_6)
pie_plot_business_hours(intersection_count_6)

```

##### 五個品項的店家當中的營業時間分布
```{r}
intersection_count_5<-intersection_counts(shopcode_count_5)
pie_plot_business_hours(intersection_count_5)
```


##### 四個品項的店家當中的營業時間分布
```{r}
intersection_count_4<-intersection_counts(shopcode_count_4)
pie_plot_business_hours(intersection_count_4)
```

##### 三個品項的店家當中的營業時間分布
```{r}
intersection_count_3<-intersection_counts(shopcode_count_3)
pie_plot_business_hours(intersection_count_3)
```

##### 二個品項的店家當中的營業時間分布
```{r}
intersection_count_2<-intersection_counts(shopcode_count_2)
pie_plot_business_hours(intersection_count_2)
```

##### 一個品項的店家當中的營業時間分布
```{r}
intersection_count_1<-intersection_counts(shopcode_count_1)
pie_plot_business_hours(intersection_count_1)
```

##### 零個品項的店家當中的營業時間分布
```{r}
intersection_count_0<-intersection_counts(shopcode_count_0)
pie_plot_business_hours(intersection_count_0)
```


- 可以發現到：不論店家有幾項熱門產品在三期命名相同，這些店家的營業時段多集中在Dinner、Lunch以及Bartime上






#### 以持續六項且供應正餐的店家作討論
|                 | (-Inf,-0.2]| (-0.2,-0.1]| (-0.1,0]|     0| (0,0.1]| (0.1,0.2]| (0.2,Inf]| mean_inflationRates|
|:----------------|-----------:|-----------:|--------:|-----:|-------:|---------:|---------:|-------------------:|
|summary_cpi_wax  |          35|         107|      137| 11469|    2626|       730|       148|           0.0150506|
|summary_cpi_wane |          27|          79|      157| 12579|    1791|       519|       100|           0.0102684|


```{r,include=FALSE}
average_inflation_rate_wax|>
  dplyr::filter(shopCode %in% tracking_shopCodes_mealOffering_6popularItems)->average_inflation_rate_wax_mealoffering_6
average_inflation_rate_wane|>
  dplyr::filter(shopCode %in% tracking_shopCodes_mealOffering_6popularItems)->average_inflation_rate_wane_mealoffering_6
summary_cpi_wax<-summarise_inflationRate2(cpi_wax) 
summary_cpi_wane<-summarise_inflationRate2(cpi_wane) 
tb_cpi_summary2 <- rbind(
      summary_cpi_wax,
      summary_cpi_wane
    )
    list(
      cpi_wax, cpi_wane
    ) |>
      purrr::map(
        mean
      ) |>
      unlist() -> mean_inflationRates

    cbind(
      tb_cpi_summary2, mean_inflationRates
    )->tb_cpi_summary2

```

```{r}

breaks <- c(-Inf,-0.2,-0.1, -1e-7, 1e-7,0.1, 0.2,Inf)
labels<-(c("(-Inf,-0.2]","(-0.2,-0.1]","(-0.1,0]","0","(0,0.1]","(0.1,0.2]","(0.2,Inf]"))


histogram1 <- cut(average_inflation_rate_wax_mealoffering_6$inflation_rate, breaks, labels)
frequency_table1 <- table(histogram1)

histogram_df1 <- data.frame(Interval = names(frequency_table1), Frequency = as.numeric(frequency_table1))
histogram_df1$Interval <- factor(histogram_df1$Interval, levels = labels, ordered = TRUE)
histogram_wax<-ggplot(histogram_df1, aes(x = Interval, y = Frequency)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Frequency), vjust = -0.5, size = 3)+
  labs(title = "The distribution of inflation rate in wax period",
       x = "Inflation Rate Intervals",
       y = "Frequency")
```


```{r}
histogram2 <- cut(average_inflation_rate_wane_mealoffering_6$inflation_rate, breaks, labels)
frequency_table2 <- table(histogram2)

histogram_df2 <- data.frame(Interval = names(frequency_table2), Frequency = as.numeric(frequency_table2))
histogram_df2$Interval <- factor(histogram_df2$Interval, levels = labels, ordered = TRUE)
histogram_wane<-ggplot(histogram_df2, aes(x = Interval, y = Frequency)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = Frequency), vjust = -0.5, size = 3)+
  labs(title = "The distribution of inflation rate in wane period",
       x = "Inflation Rate Intervals",
       y = "Frequency")
```

```{r,fig.width=10, fig.height=6}
grid.arrange(histogram_wax, histogram_wane, ncol = 2)
```


- 從圖中可以發現到，在蛋荒嚴重時有11469間店家是物價上漲率為0(以2月3日為前期,4月27日為後期)，而在蛋荒趨緩時增為12579間店家(以4月27日為前期,7月26日為後期)，增加了1110間餐廳。在蛋荒趨緩時，物價上漲率大於0的店家數量有減少的趨勢。





```{r,include=FALSE}
offermeal_breakfast<-intersect(names(names_with_breakfast),tracking_shopCodes_mealOffering)
offermeal_lunch<-intersect(names(names_with_lunch),tracking_shopCodes_mealOffering)
offermeal_dinner<-intersect(names(names_with_dinner),tracking_shopCodes_mealOffering)
data.frame(business_hour=c("breakfast","lunch","dinner"),
           numberOfShop=c(length(offermeal_breakfast),length(offermeal_lunch),
                          length(offermeal_dinner)))
```

##### 選出在breakfast、lunch、dinner提供正餐且持續6項的shopcode名單

|business_hour | numberOfShop|
|:-------------|------------:|
|breakfast     |         3514|
|lunch         |        12398|
|dinner        |        12954|

```{r,include=FALSE}
offermeal_6items_breakfast<-intersect(names(names_with_breakfast),tracking_shopCodes_mealOffering_6popularItems)
offermeal_6items_lunch<-intersect(names(names_with_lunch),tracking_shopCodes_mealOffering_6popularItems)
offermeal_6items_dinner<-intersect(names(names_with_dinner),tracking_shopCodes_mealOffering_6popularItems)
data.frame(business_hour=c("breakfast","lunch","dinner"),
           numberOfShop=c(length(offermeal_6items_breakfast),
                          length(offermeal_6items_lunch),
                          length(offermeal_6items_dinner)))
```


##### 以營業時間來討論

```{r}
intersect(names(names_with_breakfast),tracking_shopCodes_mealOffering_6popularItems)->shopCodes_mealOffering_6popularItems_Breakfast
intersect(names(names_with_lunch),tracking_shopCodes_mealOffering_6popularItems)->shopCodes_mealOffering_6popularItems_Lunch
intersect(names(names_with_dinner),tracking_shopCodes_mealOffering_6popularItems)->shopCodes_mealOffering_6popularItems_Dinner
```

|business_hour |   wax_cpi|  wane_cpi|
|:-------------|---------:|---------:|
|breakfast     | 0.0185956| 0.0095789|
|lunch         | 0.0145903| 0.0096474|
|dinner        | 0.0138364| 0.0103931|

```{r}
average_inflation_rate_wax_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Breakfast)->wax_cpi_breakfast
average_inflation_rate_wane_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Breakfast)->wane_cpi_breakfast

average_inflation_rate_wax_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Lunch)->wax_cpi_lunch
average_inflation_rate_wane_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Lunch)->wane_cpi_lunch

average_inflation_rate_wax_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Dinner)->wax_cpi_dinner
average_inflation_rate_wane_mealoffering_6|>
  dplyr::filter(shopCode %in% shopCodes_mealOffering_6popularItems_Dinner)->wane_cpi_dinner

data.frame(business_hour=c("breakfast","lunch","dinner"),
           CPI_wax=c(mean(wax_cpi_breakfast$inflation_rate),
                     mean(wax_cpi_lunch$inflation_rate),
                     mean(wax_cpi_dinner$inflation_rate)),
           CPI_wane=c(mean(wane_cpi_breakfast$inflation_rate),
                     mean(wane_cpi_lunch$inflation_rate),
                     mean(wane_cpi_dinner$inflation_rate)))->df

df|>tidyr::pivot_longer(cols=c("CPI_wax","CPI_wane"),names_to = "Period",values_to = "inflation_rate")->data_long2
data_long2$Period<-factor(data_long2$Period,
                            levels = c("CPI_wax", "CPI_wane"))

```


 

```{r}
plot_ly(data_long2, x = ~Period, y = ~inflation_rate,color = ~business_hour,text = ~paste0(business_hour, ": ", scales::percent(inflation_rate)),hoverinfo="text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(title = "Inflation Rate by Business Hour",
         xaxis = list(title = "Period"),
         yaxis = list(title = "Inflation Rate"),
         hovermode = "closest"
         ) %>%
  add_markers()%>%
  layout(showlegend = FALSE)
```

- 以早午晚餐三個時段來觀察，可以看出在蛋荒嚴重時期，早餐時段的店家之物價上漲率在1.8596%左右，是三個時段當中最高的。這是否跟早餐店需要用到大量的雞蛋有關聯?
- 蛋荒趨緩時期物價上漲率最高的則是晚餐時段的店家，約在1.0393%，猜測是否跟菜價上漲有關?而早餐時段的物價上漲率則有放緩的趨勢，來到0.9579%


##### 以城市分類並計算CPI

###### 以wax時期高至低排序
|county |   CPI_wax|  CPI_wane|
|:------|---------:|---------:|
|澎湖縣 | 0.0215527| 0.0005120|
|花蓮縣 | 0.0198006| 0.0104436|
|桃園市 | 0.0192837| 0.0094564|
|嘉義縣 | 0.0182182| 0.0099024|
|臺中市 | 0.0178917| 0.0112926|
|苗栗縣 | 0.0178311| 0.0090640|
|宜蘭縣 | 0.0174885| 0.0106448|
|新竹市 | 0.0173784| 0.0097222|
|彰化縣 | 0.0164648| 0.0097770|
|新竹縣 | 0.0158071| 0.0111707|
|基隆市 | 0.0148777| 0.0095115|
|南投縣 | 0.0147994| 0.0128719|
|臺南市 | 0.0142355| 0.0093070|
|屏東縣 | 0.0137331| 0.0113882|
|新北市 | 0.0136278| 0.0117989|
|雲林縣 | 0.0133700| 0.0097215|
|臺北市 | 0.0131325| 0.0090395|
|嘉義市 | 0.0129521| 0.0079991|
|臺東縣 | 0.0119489| 0.0201091|
|高雄市 | 0.0112796| 0.0100340|
|金門縣 | 0.0012108| 0.0114028|

```{r,include=FALSE}
tb_CPI_summary_byGroup|>
  arrange(desc(CPI_wax))
```
###### 以wane時期高至低排序

|county |   CPI_wax|  CPI_wane|
|:------|---------:|---------:|
|臺東縣 | 0.0119489| 0.0201091|
|南投縣 | 0.0147994| 0.0128719|
|新北市 | 0.0136278| 0.0117989|
|金門縣 | 0.0012108| 0.0114028|
|屏東縣 | 0.0137331| 0.0113882|
|臺中市 | 0.0178917| 0.0112926|
|新竹縣 | 0.0158071| 0.0111707|
|宜蘭縣 | 0.0174885| 0.0106448|
|花蓮縣 | 0.0198006| 0.0104436|
|高雄市 | 0.0112796| 0.0100340|
|嘉義縣 | 0.0182182| 0.0099024|
|彰化縣 | 0.0164648| 0.0097770|
|新竹市 | 0.0173784| 0.0097222|
|雲林縣 | 0.0133700| 0.0097215|
|基隆市 | 0.0148777| 0.0095115|
|桃園市 | 0.0192837| 0.0094564|
|臺南市 | 0.0142355| 0.0093070|
|苗栗縣 | 0.0178311| 0.0090640|
|臺北市 | 0.0131325| 0.0090395|
|嘉義市 | 0.0129521| 0.0079991|
|澎湖縣 | 0.0215527| 0.0005120|


```{r,include=FALSE}
tb_CPI_summary_byGroup|>
  arrange(desc(CPI_wane))
```
```{r,warning=FALSE}
tb_CPI_summary_byGroup|>
  tidyr::pivot_longer(cols=starts_with("CPI"),names_to = "Period", values_to = "InflationRate")->long_data
long_data$Period<-factor(long_data$Period,levels = c("CPI_wax","CPI_wane"))
long_data$county<-factor(long_data$county,levels=c(
  "南投縣", "嘉義市", "嘉義縣", "基隆市", "宜蘭縣", "屏東縣", "彰化縣",
  "新竹市", "新竹縣","花蓮縣","苗栗縣","雲林縣",
  "臺北市","新北市","桃園市","臺中市", "臺南市","高雄市",
  "澎湖縣","臺東縣","金門縣"))
color_vector1<-c("#FAF3F0","#F4F2DE","#FAF0D7","#EFE1D1","#FAE392","#FFFEC4",
                 "#DFD7BF","#FFFAD7","#FAF0E4","#ECE5C7","#EEE3CB","#F0EDD4",
                 "#F9F5E7","#F8EAD8","#EDDBC7","#FFE7CC","#F1DBBF","#FDEBED",
                 "#35A29F","#C63D2F","#CF0A0A"
                 )

plot_ly(long_data, x = ~Period, y = ~InflationRate,color = ~county,colors=color_vector1, text = ~paste0(county, ": ", scales::percent(InflationRate)),hoverinfo="text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(title = "Inflation Rate by County",
         xaxis = list(title = "Period"),
         yaxis = list(title = "Inflation Rate"),
         hovermode = "closest"
         ) %>%
  add_markers()%>%
  layout(showlegend = FALSE)
```

- 從wax到wane時期，只有臺東縣和金門縣的走勢是向上，其餘縣市則是下降，想特別探討這兩個縣市的菜單價格變化。另外一點，澎湖縣在wax時期的物價上漲率在2.16%左右，但在wane時期有劇烈下降幅度，降至0.0512%，是剛好在2/3至4/27這段期間多數店家菜單價格都剛好調漲嗎?

- 圖形說明:將上漲的縣市以紅色系標示，劇烈下跌之縣市用綠色標示


```{r}
long_data$county<-factor(long_data$county,levels=c(
  "南投縣", "嘉義市", "嘉義縣", "基隆市", "宜蘭縣", "屏東縣", "彰化縣",
  "新竹市", "新竹縣","花蓮縣","苗栗縣","雲林縣",
  "澎湖縣","臺東縣","金門縣",
  "臺北市","新北市","桃園市","臺中市", "臺南市","高雄市"))
color_vector2<-c("#FAF3F0","#F4F2DE","#FAF0D7","#EFE1D1","#FAE392","#FFFEC4",
                 "#DFD7BF","#FFFAD7","#FAF0E4","#ECE5C7","#EEE3CB","#F0EDD4",
                 "#FFE7CC","#F1DBBF","#FDEBED",
                 "#0C356A","#313866","#504099","#4D3C77","#5C4B99","#461959"
                 )

plot_ly(long_data, x = ~Period, y = ~InflationRate,color = ~county,colors=color_vector2, text = ~paste0(county, ": ", scales::percent(InflationRate)),hoverinfo="text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(title = "Inflation Rate by County",
         xaxis = list(title = "Period"),
         yaxis = list(title = "Inflation Rate"),
         hovermode = "closest"
         ) %>%
  add_markers()%>%
  layout(showlegend = FALSE)
```
- 特別標示出直轄市與其他縣市作比較，蛋荒嚴重時期，物價上漲率在前十名的直轄市只有桃園市及台中市，分別排在第三及第五名。但在蛋荒趨緩時期，新北市從15名躍升至第3名，高雄市也從20名升至第10名。




```{r}
municipality<-c("臺北市","新北市","桃園市","臺中市","臺南市","高雄市")
long_data|>
  dplyr::filter(county %in% municipality)->municipality_CPI

municipality_CPI$county<-factor(municipality_CPI$county,levels=c("臺北市","新北市","桃園市","臺中市","臺南市","高雄市"))

color_vector3<-c("#F5EBEB","#146C94","#D5B4B4","#19A7CE","#E4D0D0","#6DA9E4")


plot_ly(municipality_CPI, x = ~Period, y = ~InflationRate,
        color = ~county,colors = color_vector3,
        text = ~paste0(county, ": ", scales::percent(InflationRate)),hoverinfo="text")%>%
          add_lines(line = list(width = 3)) %>%
          layout(title = "Inflation Rate in Municipalities",
                 xaxis = list(title = "Period"),
                 yaxis = list(title = "Inflation Rate"),
                 hovermode = "closest") %>%
          add_markers()%>%
          layout(showlegend = FALSE)

```

- 單獨拉出直轄市來做比較
- 以wane為標準，CPI在1%以上以藍色系標示，在1%以下則用粉色系標示
- 比較六個直轄市的兩期變化，發現到桃園市的下降幅度是最明顯的，從1.93%下降至0.95%
- 而台北市在wane時期是所有直轄市中上漲幅度最小的，只有0.9%






##### 主計處公布之資料
###### 抓出主計處公布之外食費與其他外送平台餐廳可能所需成本(包括穀類及其製品、肉類、肉類製品、蛋類、水產品、蔬菜、食用油、調味品)的消費者物價指數，並使用2月、4月及7月資料進行比較
```{r,warning=FALSE}
category_CPI_Index<-readxl::read_xlsx("DepartmentOfBudget/category_CPI_Index.xlsx")

data.frame(category=category_CPI_Index$category,
           CPI_wax=log(category_CPI_Index$Apr)-log(category_CPI_Index$Feb),
           CPI_wane=log(category_CPI_Index$Jul)-log(category_CPI_Index$Apr))->category_InflationRate

category_InflationRate|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->category_InflationRate_long
category_InflationRate_long$Period<-factor(category_InflationRate_long$Period,levels = c("CPI_wax","CPI_wane"))
category_InflationRate_long$category<-factor(category_InflationRate_long$category,levels = c("穀類及其製品","肉類","肉類製品","水產品","食用油","調味品","外食費","蛋類","蔬菜"
))
color_vector4<-c("#FAF1E4","#FAF0E6","#DAC0A3","#EFB495",
                 "#FFEECC","#FFDDCC","#4682A9","#35A29F","#C63D2F")
plot_ly(category_InflationRate_long, x = ~Period, y = ~InflationRate,color = ~category,colors=color_vector4,text = ~paste0(category, ": ", scales::percent(InflationRate)),hoverinfo="text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(title = "Inflation Rate by category",
         xaxis = list(title = "Period"),
         yaxis = list(title = "Inflation Rate"),
         hovermode = "closest"
         ) %>%
  add_markers()%>%
  layout(showlegend = FALSE)
```

- 除了蔬菜有較高的漲幅、蛋類有明顯跌幅外，其餘種類皆無太明顯的漲跌幅。而外食費的上漲幅度也趨緩，從1.4677%降至0.8878%。


##### 台北市政府主計處公布之資料
```{r}
food_CPI_Index_Taipei<-read_xlsx("DepartmentOfBudget/Taipei/food_CPI_Index.xlsx")
filtered_Taipei <- long_data %>% filter(county == "臺北市")
data.frame(category=food_CPI_Index_Taipei$category,
           CPI_wax=log(food_CPI_Index_Taipei$Apr)-log(food_CPI_Index_Taipei$Feb),
           CPI_wane=log(food_CPI_Index_Taipei$Jul)-log(food_CPI_Index_Taipei$Apr))->food_InflationRate_Taipei

food_InflationRate_Taipei|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->food_InflationRate_Taipei_long
food_InflationRate_Taipei_long$Period<-factor(food_InflationRate_Taipei_long$Period,levels = c("CPI_wax","CPI_wane"))


plot_ly(food_InflationRate_Taipei_long, x = ~Period, y = ~InflationRate,
                text = ~paste0("臺北市政府公布之食物類:", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3))%>%
  add_trace(
    data = filtered_Taipei,
    x = ~Period,
    y = ~InflationRate,
    type = "scatter",
    mode = "lines",
    line = list(width = 3),
    text = ~paste0( "外送平台統計: ", scales::percent(InflationRate)), 
    hoverinfo = "text"
  )%>%
  layout(
    title = "Inflation Rate ",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )
```
- 比較臺北市政府主計處公布之食物類CPI指數與Foodpanda平台統計資料做比較
- 四月至七月跌幅從何而來？蛋類供給量增加，蛋價明顯下跌

```{r}
category_CPI_Index_Taipei<-readxl::read_xlsx("DepartmentOfBudget/Taipei/category_CPI_Index_Taipei.xlsx")

data.frame(category=category_CPI_Index_Taipei$category,
           CPI_wax=log(category_CPI_Index_Taipei$Apr)-log(category_CPI_Index_Taipei$Feb),
           CPI_wane=log(category_CPI_Index_Taipei$Jul)-log(category_CPI_Index_Taipei$Apr))->category_InflationRate_Taipei

category_InflationRate_Taipei|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->category_InflationRate_Taipei_long
category_InflationRate_Taipei_long$Period<-factor(category_InflationRate_Taipei_long$Period,levels = c("CPI_wax","CPI_wane"))
category_InflationRate_Taipei_long$category<-factor(category_InflationRate_Taipei_long$category,levels = c("穀類及其製品","肉類","肉類製品","水產品","食用油","調味品","外食費","蛋類","蔬菜"
))
color_vector4<-c("#FAF1E4","#FAF0E6","#DAC0A3","#EFB495",
                 "#FFEECC","#FFDDCC","#4682A9","#35A29F","#C63D2F")





filtered_Taipei <- long_data %>% filter(county == "臺北市")

plot_ly(category_InflationRate_Taipei_long, x = ~Period, y = ~InflationRate,
                color = ~category, colors = color_vector4,
                text = ~paste0(category, ": ", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(
    title = "Inflation Rate by Category",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )%>%
  add_markers()


```


##### 台中市政府主計處公布之資料
```{r}
food_CPI_Index_Taichung<-read_xlsx("DepartmentOfBudget/Taichung/food_CPI_index_Taicgung.xlsx")
filtered_Taichung <- long_data %>% filter(county == "臺中市")
data.frame(category=food_CPI_Index_Taichung$category,
           CPI_wax=log(food_CPI_Index_Taichung$Apr)-log(food_CPI_Index_Taichung$Feb),
           CPI_wane=log(food_CPI_Index_Taichung$Jul)-log(food_CPI_Index_Taichung$Apr))->food_InflationRate_Taichung

food_InflationRate_Taichung|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->food_InflationRate_Taichung_long
food_InflationRate_Taichung_long$Period<-factor(food_InflationRate_Taichung_long$Period,levels = c("CPI_wax","CPI_wane"))


plot_ly(food_InflationRate_Taichung_long, x = ~Period, y = ~InflationRate,
                text = ~paste0("臺中市政府公布之食物類:", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3))%>%
  add_trace(
    data = filtered_Taichung,
    x = ~Period,
    y = ~InflationRate,
    type = "scatter",
    mode = "lines",
    line = list(width = 3),
    text = ~paste0( "外送平台統計: ", scales::percent(InflationRate)), 
    hoverinfo = "text"
  )%>%
  layout(
    title = "Inflation Rate ",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )
```
- 在蛋荒嚴重時期，Foodpanda平台上臺中市的CPI上漲率為1.79%，台中市政府公布的CPI上漲率為1.8%，兩者差異不大。但在蛋荒趨緩時期，Foodpanda上的CPI上漲率在1.13%，而台中市政府主計處公布的為-1.2。

```{r}


category_CPI_Index_Taichung<-readxl::read_xlsx("DepartmentOfBudget/Taichung/category_CPI_Index_Taichung.xlsx")

data.frame(category=category_CPI_Index_Taichung$category,
           CPI_wax=log(category_CPI_Index_Taichung$Apr)-log(category_CPI_Index_Taichung$Feb),
           CPI_wane=log(category_CPI_Index_Taichung$Jul)-log(category_CPI_Index_Taichung$Apr))->category_InflationRate_Taichung

category_InflationRate_Taichung|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->category_InflationRate_Taichung_long
category_InflationRate_Taichung_long$Period<-factor(category_InflationRate_Taichung_long$Period,levels = c("CPI_wax","CPI_wane"))
category_InflationRate_Taichung_long$category<-factor(category_InflationRate_Taichung_long$category,levels = c("穀類及其製品","肉類","肉類製品","水產品","食用油","調味品","外食費","蛋類","蔬菜"
))
color_vector4<-c("#FAF1E4","#FAF0E6","#DAC0A3","#EFB495",
                 "#FFEECC","#FFDDCC","#4682A9","#35A29F","#C63D2F")




plot_ly(category_InflationRate_Taichung_long, x = ~Period, y = ~InflationRate,
                color = ~category, colors = color_vector4,
                text = ~paste0(category, ": ", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(
    title = "Inflation Rate by Category",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )%>%
  add_markers()

```
- 台中市的蔬菜類CPI漲幅較小

##### 新北市政府主計處公布之資料
```{r}
food_CPI_Index_NewTaipei<-read_xlsx("DepartmentOfBudget/NewTaipei/food_CPI_Index_NewTaipei.xlsx")
filtered_NewTaipei <- long_data %>% filter(county == "新北市")
data.frame(category=food_CPI_Index_NewTaipei$category,
           CPI_wax=log(food_CPI_Index_NewTaipei$Apr)-log(food_CPI_Index_NewTaipei$Feb),
           CPI_wane=log(food_CPI_Index_NewTaipei$Jul)-log(food_CPI_Index_NewTaipei$Apr))->food_InflationRate_NewTaipei

food_InflationRate_NewTaipei|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->food_InflationRate_NewTaipei_long
food_InflationRate_NewTaipei_long$Period<-factor(food_InflationRate_NewTaipei_long$Period,levels = c("CPI_wax","CPI_wane"))


plot_ly(food_InflationRate_NewTaipei_long, x = ~Period, y = ~InflationRate,
                text = ~paste0("新北市政府公布之食物類:", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3))%>%
  add_trace(
    data = filtered_NewTaipei,
    x = ~Period,
    y = ~InflationRate,
    type = "scatter",
    mode = "lines",
    line = list(width = 3),
    text = ~paste0( "外送平台統計: ", scales::percent(InflationRate)), 
    hoverinfo = "text"
  )%>%
  layout(
    title = "Inflation Rate ",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )
```
- 新北市政府公布的CPI資料從1.2%下降至0.1%，相較於台北市及台中市，是直轄市中唯一上漲的。

```{r}


category_CPI_Index_NewTaipei<-readxl::read_xlsx("DepartmentOfBudget/NewTaipei/category_CPI_Index_NewTaipei.xlsx")

data.frame(category=category_CPI_Index_NewTaipei$category,
           CPI_wax=log(category_CPI_Index_NewTaipei$Apr)-log(category_CPI_Index_NewTaipei$Feb),
           CPI_wane=log(category_CPI_Index_NewTaipei$Jul)-log(category_CPI_Index_NewTaipei$Apr))->category_InflationRate_NewTaipei

category_InflationRate_NewTaipei|>
  tidyr::pivot_longer(cols = starts_with("CPI"),names_to = "Period",values_to = "InflationRate")->category_InflationRate_NewTaipei_long
category_InflationRate_NewTaipei_long$Period<-factor(category_InflationRate_NewTaipei_long$Period,levels = c("CPI_wax","CPI_wane"))
category_InflationRate_NewTaipei_long$category<-factor(category_InflationRate_NewTaipei_long$category,levels = c("穀類及其製品","肉類","肉類製品","水產品","食用油","調味品","外食費","蛋類","蔬菜"
))
color_vector4<-c("#FAF1E4","#FAF0E6","#DAC0A3","#EFB495",
                 "#FFEECC","#FFDDCC","#4682A9","#35A29F","#C63D2F")


plot_ly(category_InflationRate_NewTaipei_long, x = ~Period, y = ~InflationRate,
                color = ~category, colors = color_vector4,
                text = ~paste0(category, ": ", scales::percent(InflationRate)),
                hoverinfo = "text") %>%
  add_lines(line = list(width = 3)) %>%
  layout(
    title = "Inflation Rate by Category",
    xaxis = list(title = "Period"),
    yaxis = list(title = "Inflation Rate"),
    hovermode = "closest",
    showlegend = FALSE
  )%>%
  add_markers()
```

- 新北市政府公布的細項CPI中，蔬菜漲幅較高，來到11.3888%
